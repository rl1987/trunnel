a trunnel is a primitive nail

===================================================================

const X = 20;
   // Assume these have real definitions.
   struct name2 { u8 foo; }
   struct name3 { u8 foo; }
   struct name4 { u8 foo; }
   struct xx { u8 foo; }
   struct yy { u8 foo; }

   const TYPE1 = 1;
   const TYPE2 = 2;
   const TYPE3 = 3;

   struct name {
      u8 thing1 IN [0..20];
      u16 thing2;


      u8 thing_x IN [TYPE1, TYPE2, TYPE3];

      u8 thing3[20];
      u32 thing4[X];

      struct name2 thing5;

      struct name2 thing6[2];

      nulterm thing7;

      u8 count;

      struct name2 counted[count];

      u8 count2;
      char string[count2];
      char buf[10];
 
      u8 tag_field;
      union union_field[tag_field] {
         3 : struct name3 v1 ;
         4 : struct name4 v2 ;
         default : fail;
      };

      eos;
   }


   struct namex {
       u8 tag;
       u8 length;

       union fred[tag] WITH LENGTH length {
           4: struct x field1;
           5: struct x field2;
           default: ignore;
       };
   }

   Can't express yet: list of structures terminated by a 0 byte.  (Do we have
   any of those?)








==============================

 File = Declaration*

 Declaration = ConstDecl | StructDecl

 ConstDecl = "const" CONST_NAME "=" IntLiteral ";"

 StructDecl = "struct" StructName "{" StructMember* SMEos? "}" ";"

 SMEos = "eos" ";"

 Integer = IntLiteral | CONST_NAME

 StructMember = ( SMInteger |
                  SMStruct |
  		  SMString |
 		  SMArray |
		  SMUnion ) ";"

  SMInteger = IntType MemberName ( IN IntSet ) ?

  IntType = "u8" | "u16" | "u32" | "u64"

  IntSet = "[" IntList  "]"
  IntList = IntListMember | IntList "," IntListMember
  IntListMember = Integer | Integer ".." Integer

  SMStruct = "struct" StructName MemberName

  SMString = "nulterm" Membername

  SMArray = SMFixedArray | SMVarArray

  ArrayBase = IntType | "struct" StructName | "char"

  SMVarArray = ArrayBase MemberName "[" MemberName "]"

  SMFixedArray = ArrayBase MemberName "[" Integer "]"

  SMUnion = "union" MemberName "[" MemberName "]" UnionLength?
                    "{" UnionMember* UMDefault? "}" ";"

  UnionLength = "WITH" "LENGTH" MemberName

  UnionMember = IntList ":" (SMInteger | SMFixedArray | SMString | SMStruct) 
                   ExtentSpec? ";"

  ExtentSpec = "..."

  UMDefault = "default" ":" ( u8 MemberName "[" "]" |
                              "fail" |
			      "ignore" ) ";"

  MemberName = [a-z_][a-z0-9_]*
  StructName = [a-z_][a-z0-9_]*
  CONST_NAME = [A-Z_][A-Z0-9_]*
 
Additional constraints:

   Structure declarations form a DAG.

   Field references in SMVarArray and SMUnion and SMUnionLength refer
   only to earlier-occurring fields in the same structure.

   No ExtentSpec unless the union has a UnionLength.



========================================

Expanded grammar:


 File = Declaration
      = File Declaration

 Declaration = ConstDecl 
             = StructDecl

 ConstDecl = "const" CONST_NAME "=" IntLiteral ";"

 StructDecl = "struct" StructName "{" StructMembers OptSMEos "}"

 OptSMEos = "eos" ";"
 OptSMEos =

 StructMembers = StructMember ";"
 StructMembers = StructMembers StructMember ";"

 Integer = IntLiteral
 Integer = CONST_NAME

 StructMember = SMInteger
 StructMember = SMStruct
 StructMember = SMString
 StructMember = SMArray
 StructMember = SMUnion

 SMInteger = IntType MemberName OptIntConstraint

 IntType = "u8"
 IntType = "u16"
 IntType = "u32"
 IntType = "u64"

 OptIntConstraint = ( IN "[" IntList "]" )
 OptIntConstraint =

 IntList = IntListMember
 IntList = IntListMember "," IntList
 IntListMember = Integer
 IntListMember = Integer ".." Integer

 SMStruct = "struct" StructName MemberName

 SMString = "nulterm" Membername

 SMArray = SMFixedArray
 SMArray = SMVarArray

 ArrayBase = IntType
 ArrayBase = "struct" StructName
 ArrayBase = "char"

 SMVarArray = ArrayBase MemberName "[" MemberName "]"

 SMFixedArray = ArrayBase MemberName "[" Integer "]"

 
 SMUnion = "union" MemberName "[" MemberName "]" OptUnionLength
                   "{" UnionMembers OptUMDefault "}" 

 OptUnionLength = "WITH" "LENGTH" MemberName
 OptUnionLength =

 UnionMembers = UnionMember ";"
 UnionMembers = UnionMembers UnionMember ";"

 UnionMember = IntList ":" UnionField
                  OptExtentSpec

 UnionField = SMInteger
 UnionField = SMFixedArray
 UnionField = SMString
 UnionField = SMStruct

 OptExtentSpec = "..."
 OptExtentSpec =

 OptUMDefault =
 OptUMDefault = "default" ":" UMDefaultField ";"

 UMDefaultField = "u8" MemberName "[" "]"
 UMDefaultField = "fail"
 UMDefaultField = "ignore"

  MemberName = [a-z_][a-z0-9_]*
  StructName = [a-z_][a-z0-9_]*
  CONST_NAME = [A-Z_][A-Z0-9_]*
 
